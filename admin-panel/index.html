<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neyroon Bot - –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .auth-section {
            margin-top: 15px;
        }

        .auth-section input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            width: 300px;
        }

        .auth-section button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .auth-section button:hover {
            background: #0056b3;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab.active {
            background: #007bff;
            color: white;
        }

        .content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }

        .content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            /* –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
            scroll-behavior: smooth;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .color-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .color-option:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }

        .color-option input[type="radio"] {
            margin-right: 10px;
            cursor: pointer;
        }

        .color-option input[type="radio"]:checked + .color-badge {
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3);
        }

        .color-badge {
            padding: 6px 12px;
            color: white;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            flex: 1;
            text-align: center;
        }

        .error {
            color: #dc3545;
            padding: 10px;
            background: #f8d7da;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .success {
            color: #155724;
            padding: 10px;
            background: #d4edda;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        /* Toast notification styles */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #4CAF50;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }

        .toast.error {
            background: #f44336;
        }

        .toast.warning {
            background: #ff9800;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.hiding {
            animation: slideOut 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Neyroon Bot - –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h1>
            <div class="auth-section">
                <input type="password" id="apiKey" placeholder="–í–≤–µ–¥–∏—Ç–µ Admin Secret Key">
                <button onclick="authenticate()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
                <span id="connectionStatus" class="status disconnected">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="showTab('stats')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            <button class="tab" onclick="showTab('welcome')">‚öôÔ∏è –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</button>
            <button class="tab" onclick="showTab('payment-settings')">üí≥ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø–ª–∞—Ç—ã</button>
            <button class="tab" onclick="showTab('users')">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
            <button class="tab" onclick="showTab('lessons')">–£—Ä–æ–∫–∏</button>
            <button class="tab" onclick="showTab('drawings')">–†–∏—Å—É–Ω–∫–∏</button>
            <button class="tab" onclick="showTab('payments')">–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</button>
            <button class="tab" onclick="showTab('test')">üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
        </div>

        <div id="stats-content" class="content active">
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <div id="statsData" class="stats-grid"></div>
        </div>

        <div id="welcome-content" class="content">
            <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è</h2>
            <p style="margin-bottom: 20px; color: #666;">
                –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —É–≤–∏–¥—è—Ç –Ω–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞.
            </p>

            <div style="background: white; padding: 30px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0;">–¢–µ–∫—É—â–µ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</h3>

                <!-- –ü—Ä–µ–≤—å—é -->
                <div id="welcomePreview" style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div id="welcomePreviewPhoto" style="margin-bottom: 15px; text-align: center;"></div>
                    <div id="welcomePreviewText" style="white-space: pre-wrap; margin-bottom: 15px;"></div>
                    <div id="welcomePreviewButtons" style="display: flex; gap: 10px; justify-content: center;"></div>
                </div>

                <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <h3 style="margin-bottom: 15px;">üîí –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</h3>
                <p style="color: #666; margin-bottom: 20px;">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —ç–∫—Ä–∞–Ω–∞ —Å–æ–≥–ª–∞—Å–∏—è —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π. –ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –ø—É—Å—Ç—ã–º, —ç–∫—Ä–∞–Ω –Ω–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è.</p>

                <div class="form-group">
                    <label>üìù –¢–µ–∫—Å—Ç –ø–æ–ª–∏—Ç–∏–∫–∏:</label>

                    <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
                    <div style="display: flex; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f5f5f5; border-radius: 4px; flex-wrap: wrap;">
                        <button type="button" onclick="insertPolicyFormatting('bold')" style="padding: 6px 12px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-weight: bold;" title="–ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç">
                            <strong>B</strong>
                        </button>
                        <button type="button" onclick="insertPolicyFormatting('italic')" style="padding: 6px 12px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-style: italic;" title="–ö—É—Ä—Å–∏–≤">
                            <em>I</em>
                        </button>
                        <button type="button" onclick="insertPolicyFormatting('code')" style="padding: 6px 12px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-family: monospace;" title="–ú–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç">
                            <code>&lt;/&gt;</code>
                        </button>
                        <div style="width: 1px; background: #ddd; margin: 0 4px;"></div>
                        <button type="button" onclick="insertPolicyLink()" style="padding: 6px 12px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" title="–í—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É">
                            üîó –°—Å—ã–ª–∫–∞
                        </button>
                        <button type="button" onclick="insertPolicyNewline()" style="padding: 6px 12px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" title="–ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞">
                            ‚Üµ –ü–µ—Ä–µ–Ω–æ—Å
                        </button>
                        <div style="width: 1px; background: #ddd; margin: 0 4px;"></div>
                        <button type="button" onclick="clearPolicyText()" style="padding: 6px 12px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; color: #d32f2f;" title="–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—Å—Ç">
                            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                    </div>

                    <textarea
                        id="policyTextInput"
                        rows="6"
                        placeholder="–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏:&#10;&#10;[–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏](https://example.com/privacy)&#10;[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ](https://example.com/terms)"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 13px; resize: vertical;"
                    ></textarea>
                    <small style="color: #666;">
                        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è Markdown: <code>**–∂–∏—Ä–Ω—ã–π**</code>, <code>*–∫—É—Ä—Å–∏–≤*</code>, <code>`–∫–æ–¥`</code>, <code>[—Ç–µ–∫—Å—Ç](url)</code>
                    </small>
                </div>

                <div class="form-group">
                    <label>‚úÖ –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å–æ–≥–ª–∞—Å–∏—è:</label>
                    <input
                        type="text"
                        id="policyButtonInput"
                        placeholder="–Ø —Å–æ–≥–ª–∞—Å–µ–Ω"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
                    >
                </div>

                <div style="background: #e7f3ff; border: 1px solid #2196F3; border-radius: 8px; padding: 15px; margin-top: 15px;">
                    <h4 style="margin-top: 0; color: #2196F3;">üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h4>
                    <div id="policyPreview" style="white-space: pre-wrap; font-size: 14px; color: #333; line-height: 1.6;"></div>
                </div>

                <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">

                <div class="form-group">
                    <label>üì∏ –§–æ—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è:</label>
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 5px;">
                        <input type="file" id="welcomePhotoInput" accept="image/*" style="flex: 1;">
                        <button class="btn btn-primary" onclick="uploadWelcomePhoto()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                        <button class="btn btn-danger" onclick="removeWelcomePhoto()">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        –§–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF, WebP. –ú–∞–∫—Å–∏–º—É–º 5 –ú–ë.
                    </small>
                </div>

                <div class="form-group">
                    <label>üìù –¢–µ–∫—Å—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è:</label>
                    <textarea
                        id="welcomeTextInput"
                        rows="8"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è..."
                    ></textarea>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: **–∂–∏—Ä–Ω—ã–π**, *–∫—É—Ä—Å–∏–≤*, `–∫–æ–¥`
                    </small>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>üü¢ –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ "–ù–æ–≤–∏—á–æ–∫":</label>
                        <input
                            type="text"
                            id="welcomeButtonNewbieInput"
                            placeholder="–ù–æ–≤–∏—á–æ–∫"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
                        >
                    </div>

                    <div class="form-group">
                        <label>üîµ –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ "–£–∂–µ –∑–Ω–∞–∫–æ–º":</label>
                        <input
                            type="text"
                            id="welcomeButtonExperiencedInput"
                            placeholder="–£–∂–µ –∑–Ω–∞–∫–æ–º"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
                        >
                    </div>
                </div>

                <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                <h3 style="margin-bottom: 15px;">üéØ –ë–ª–æ–∫ –ø—Ä–∏–∑—ã–≤–∞ –∫ –¥–µ–π—Å—Ç–≤–∏—é –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤</h3>
                <p style="color: #666; margin-bottom: 20px;">–¢–µ–∫—Å—Ç –∏ –∫–Ω–æ–ø–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —É—Ä–æ–∫–æ–≤</p>

                <div class="form-group">
                    <label>üìù –¢–µ–∫—Å—Ç –ø—Ä–∏–∑—ã–≤–∞ (CTA):</label>
                    <textarea
                        id="newbieCtaTextInput"
                        rows="3"
                        placeholder="üëÜ –ü–æ—Å–º–æ—Ç—Ä–µ–ª–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —É—Ä–æ–∫–∏?&#10;&#10;–ì–æ—Ç–æ–≤—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –ø–æ–ª–Ω–æ–º—É –∫—É—Ä—Å—É?"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;"
                    ></textarea>
                    <small style="color: #666;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</small>
                </div>

                <div class="form-group">
                    <label>üöÄ –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏:</label>
                    <input
                        type="text"
                        id="newbieCtaButtonInput"
                        placeholder="üöÄ –•–æ—á—É –≤ –ø—Ä–æ–µ–∫—Ç"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
                    >
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="saveWelcomeSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    <button class="btn" onclick="loadWelcomeSettings()">üîÑ –û—Ç–º–µ–Ω–∏—Ç—å</button>
                </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div style="background: #e7f3ff; border: 1px solid #2196F3; border-radius: 8px; padding: 15px;">
                <h4 style="margin-top: 0; color: #2196F3;">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞</h4>
                <ul style="margin: 0; padding-left: 20px;">
                    <li>–§–æ—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ–∑–¥–∞—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ –≤–∞—à–µ–º –∫—É—Ä—Å–µ</li>
                    <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—Ä–∞—Ç–∫–∏–π, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π —Ç–µ–∫—Å—Ç (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)</li>
                    <li>–ö–Ω–æ–ø–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –ø–µ—Ä–≤—ã–π –æ–ø—ã—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –±–æ—Ç–æ–º</li>
                    <li>–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</li>
                </ul>
            </div>
        </div>

        <div id="payment-settings-content" class="content">
            <h2>üí≥ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø–ª–∞—Ç—ã</h2>
            <p style="margin-bottom: 20px; color: #666;">
                –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–ø–ª–∞—Ç–µ, —Ü–µ–Ω—É –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã.
            </p>

            <!-- –ë–ª–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–µ–∫—Å—Ç–∞ –æ–ø–ª–∞—Ç—ã -->
            <div class="card">
                <h3>–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ–ø–ª–∞—Ç–µ</h3>
                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    –≠—Ç–æ—Ç —Ç–µ–∫—Å—Ç —É–≤–∏–¥—è—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ "–•–æ—á—É –≤ –ø—Ä–æ–µ–∫—Ç". –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Markdown.
                </p>

                <!-- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ -->
                <div style="display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;">
                    <button type="button" onclick="insertPaymentFormatting('bold')"
                            style="padding: 6px 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        <strong>B</strong>
                    </button>
                    <button type="button" onclick="insertPaymentFormatting('italic')"
                            style="padding: 6px 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer;">
                        <em>I</em>
                    </button>
                    <button type="button" onclick="insertPaymentFormatting('code')"
                            style="padding: 6px 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-family: monospace;">
                        <code>&lt;/&gt;</code>
                    </button>
                    <button type="button" onclick="insertPaymentLink()"
                            style="padding: 6px 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer;">
                        üîó –°—Å—ã–ª–∫–∞
                    </button>
                    <button type="button" onclick="insertPaymentNewline()"
                            style="padding: 6px 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer;">
                        ‚Üµ –ü–µ—Ä–µ–Ω–æ—Å
                    </button>
                    <button type="button" onclick="clearPaymentText()"
                            style="padding: 6px 12px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; cursor: pointer;">
                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                    </button>
                </div>

                <!-- Live Preview -->
                <div id="paymentPreview" style="padding: 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; margin-bottom: 10px; min-height: 60px; white-space: pre-wrap;"></div>

                <!-- –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–π –≤—Å—Ç–∞–≤–∫–∏ -->
                <div style="margin-bottom: 10px;">
                    <button onclick="insertAtCursor('paymentTextInput', '[—Ü–µ–Ω—ã]')"
                            style="padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; margin-right: 8px;">
                        üí∞ –í—Å—Ç–∞–≤–∏—Ç—å [—Ü–µ–Ω—ã]
                    </button>
                    <small style="color: #666;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ [—Ü–µ–Ω—ã] –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö —Ü–µ–Ω –∏–∑ –º–µ—Ç–æ–¥–æ–≤ –æ–ø–ª–∞—Ç—ã</small>
                </div>

                <!-- Textarea -->
                <textarea id="paymentTextInput" rows="8" oninput="updatePaymentPreview()"
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä:&#10;üé® **–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –ø–æ–ª–Ω–æ–º—É –∫—É—Ä—Å—É —Ä–∏—Å–æ–≤–∞–Ω–∏—è!**&#10;&#10;‚ú® **–ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:**&#10;‚Ä¢ –î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —É—Ä–æ–∫–∞–º&#10;‚Ä¢ –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤&#10;‚Ä¢ –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è&#10;&#10;–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:"
                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 13px; resize: vertical;">
                </textarea>

                <h3 style="margin-top: 25px;">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–ø–∏—Å–∫–∏</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">–¶–µ–Ω–∞</label>
                        <input type="number" id="paymentPriceInput" placeholder="5000"
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">–í–∞–ª—é—Ç–∞</label>
                        <select id="paymentCurrencyInput" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="KZT">KZT (–¢–µ–Ω–≥–µ)</option>
                            <option value="RUB">RUB (–†—É–±–ª—å)</option>
                            <option value="USD">USD (–î–æ–ª–ª–∞—Ä)</option>
                            <option value="EUR">EUR (–ï–≤—Ä–æ)</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–µ–π)</label>
                        <input type="number" id="paymentDurationInput" placeholder="30"
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>

                <h3 style="margin-top: 25px;">Telegram ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
                <div style="margin-top: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Telegram ID</label>
                    <input type="text" id="adminTelegramIdInput" placeholder="123456789"
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666; display: block; margin-top: 5px;">–ù–∞ —ç—Ç–æ—Ç Telegram ID –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö –Ω–∞ –æ–ø–ª–∞—Ç—É</small>
                </div>

                <button onclick="savePaymentSettings()"
                        style="margin-top: 20px; padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
            </div>

            <!-- –ë–ª–æ–∫ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã -->
            <div class="card" style="margin-top: 25px;">
                <h3>–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã</h3>
                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    –£–ø—Ä–∞–≤–ª—è–π—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏ –æ–ø–ª–∞—Ç—ã. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–≤–∏–¥—è—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –æ–ø–ª–∞—Ç—ã.
                </p>

                <button onclick="showAddPaymentMethodModal()"
                        style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 15px;">
                    + –î–æ–±–∞–≤–∏—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã
                </button>

                <div id="paymentMethodsTable"></div>
            </div>

            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã -->
            <div id="paymentMethodModal" class="modal">
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close" onclick="closePaymentMethodModal()">&times;</span>
                    <h3 id="paymentMethodModalTitle">–î–æ–±–∞–≤–∏—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h3>

                    <input type="hidden" id="paymentMethodId">

                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã:</label>
                        <input type="text" id="paymentMethodName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ÆKassa">
                    </div>

                    <div class="form-group">
                        <label>–°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã:</label>
                        <input type="url" id="paymentMethodUrl" placeholder="https://example.com/pay">
                    </div>

                    <div class="form-group">
                        <label>–¢–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ:</label>
                        <input type="text" id="paymentMethodButtonText" placeholder="üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ –ÆKassa">
                    </div>

                    <div class="form-group">
                        <label>–¶–µ–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                        <input type="number" id="paymentMethodPrice" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—â—É—é —Ü–µ–Ω—É">
                        <small style="color: #666; display: block; margin-top: 5px;">–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —ç—Ç–∞ —Ü–µ–Ω–∞ –≤–º–µ—Å—Ç–æ –æ–±—â–µ–π. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å {price} –≤ URL.</small>
                    </div>

                    <div class="form-group">
                        <label>–í–∞–ª—é—Ç–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å–ø–æ—Å–æ–±–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                        <select id="paymentMethodCurrency">
                            <option value="">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—â—É—é –≤–∞–ª—é—Ç—É</option>
                            <option value="KZT">KZT (–¢–µ–Ω–≥–µ)</option>
                            <option value="RUB">RUB (–†—É–±–ª—å)</option>
                            <option value="USD">USD (–î–æ–ª–ª–∞—Ä)</option>
                            <option value="EUR">EUR (–ï–≤—Ä–æ)</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px;">–í–∞–ª—é—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</small>
                    </div>

                    <div class="form-group">
                        <label>–¶–≤–µ—Ç –∫–Ω–æ–ø–∫–∏ –≤ Telegram:</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <label class="color-option">
                                <input type="radio" name="buttonColor" value="primary" checked>
                                <span class="color-badge" style="background: #007bff;">–°–∏–Ω–∏–π (primary)</span>
                            </label>
                            <label class="color-option">
                                <input type="radio" name="buttonColor" value="secondary">
                                <span class="color-badge" style="background: #6c757d;">–°–µ—Ä—ã–π (secondary)</span>
                            </label>
                            <label class="color-option">
                                <input type="radio" name="buttonColor" value="positive">
                                <span class="color-badge" style="background: #28a745;">–ó–µ–ª—ë–Ω—ã–π (positive)</span>
                            </label>
                            <label class="color-option">
                                <input type="radio" name="buttonColor" value="negative">
                                <span class="color-badge" style="background: #dc3545;">–ö—Ä–∞—Å–Ω—ã–π (negative)</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>–ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
                        <input type="number" id="paymentMethodOrder" min="0" value="0" placeholder="0">
                        <small style="color: #666; display: block; margin-top: 5px;">–ú–µ–Ω—å—à–µ–µ —á–∏—Å–ª–æ = –≤—ã—à–µ –≤ —Å–ø–∏—Å–∫–µ</small>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="paymentMethodActive" checked style="margin-right: 8px;">
                            –ê–∫—Ç–∏–≤–µ–Ω (–≤–∏–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º)
                        </label>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="savePaymentMethod()" class="btn btn-success">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                        <button onclick="closePaymentMethodModal()" class="btn btn-secondary">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="users-content" class="content">
            <h2>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
            <div id="usersData"></div>
        </div>

        <div id="lessons-content" class="content">
            <h2>üìö –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Ä–æ–∫–∞–º–∏</h2>
            <p style="margin-bottom: 20px; color: #666;">
                –î–æ–±–∞–≤–ª—è–π—Ç–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∏ —É–¥–∞–ª—è–π—Ç–µ —É—Ä–æ–∫–∏ –∫—É—Ä—Å–∞.
            </p>

            <div style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="openAddLessonModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫</button>
            </div>

            <div id="lessonsData"></div>

            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—Ä–æ–∫–∞ -->
            <div id="lessonModal" class="modal">
                <div class="modal-content" style="max-width: 800px;">
                    <h3 id="lessonModalTitle">–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫</h3>

                    <input type="hidden" id="lessonId">

                    <div class="form-group">
                        <label>–ù–æ–º–µ—Ä —É—Ä–æ–∫–∞:</label>
                        <input type="number" id="lessonNumber" min="1" placeholder="1">
                    </div>

                    <div class="form-group">
                        <label>–¢–∏–ø —É—Ä–æ–∫–∞:</label>
                        <select id="lessonType">
                            <option value="FREE">FREE - –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —É—Ä–æ–∫</option>
                            <option value="PREMIUM">PREMIUM - –ü—Ä–µ–º–∏—É–º —É—Ä–æ–∫</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                        <input type="text" id="lessonTitle" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞">
                    </div>

                    <div class="form-group">
                        <label>–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                        <textarea id="lessonDescription" rows="3" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–∞"></textarea>
                    </div>

                    <div class="form-group">
                        <label>URL –ø—Ä–µ–≤—å—é –≤–∏–¥–µ–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                        <input type="url" id="lessonPreviewUrl" placeholder="https://youtube.com/...">
                    </div>

                    <div class="form-group">
                        <label>URL –ø–æ–ª–Ω–æ–≥–æ –≤–∏–¥–µ–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                        <input type="url" id="lessonFullUrl" placeholder="https://youtube.com/...">
                    </div>

                    <div class="form-group">
                        <label>–¢–µ–∫—Å—Ç –ø—Ä–∞–∫—Ç–∏–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                        <textarea id="lessonPractice" rows="4" placeholder="–ó–∞–¥–∞–Ω–∏–µ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏"></textarea>
                    </div>

                    <div class="form-group">
                        <label>–ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
                        <input type="number" id="lessonOrder" min="0" placeholder="0">
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="lessonActive" checked>
                            –£—Ä–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω
                        </label>
                    </div>

                    <div class="form-group">
                        <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∏–¥–µ–æ:</label>
                        <div id="lessonVideos" style="margin-top: 10px;">
                            <!-- –°–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                        <button type="button" class="btn" onclick="addLessonVideo()" style="margin-top: 10px;">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–µ–æ
                        </button>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" class="btn btn-success" onclick="saveLesson()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button type="button" class="btn" onclick="closeLessonModal()">‚ùå –û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="drawings-content" class="content">
            <h2>–†–∏—Å—É–Ω–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</h2>
            <div id="drawingsData"></div>
        </div>

        <div id="payments-content" class="content">
            <h2>–ó–∞—è–≤–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É</h2>
            <div id="paymentRequestsData"></div>

            <h2 style="margin-top: 30px;">–û–∂–∏–¥–∞—é—â–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</h2>
            <div id="pendingPaymentsData"></div>

            <h2 style="margin-top: 30px;">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏</h2>
            <div id="paymentsData"></div>
        </div>

        <div id="test-content" class="content">
            <h2>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π</h2>
            <p style="margin-bottom: 20px; color: #666;">
                –°–∏–º—É–ª–∏—Ä—É–π—Ç–µ —É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
                –í—ã–±–µ—Ä–∏—Ç–µ pending –ø–æ–¥–ø–∏—Å–∫—É –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
            </p>

            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 15px; margin-bottom: 20px;">
                <strong>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:</strong> –≠—Ç–∏ endpoint'—ã –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
                –í production –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω—ã.
            </div>

            <h3>Pending –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            <div id="testPendingPayments"></div>

            <h3 style="margin-top: 30px;">–ü—Ä—è–º–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <div style="background: white; padding: 20px; border-radius: 8px;">
                <div class="form-group">
                    <label>Subscription ID:</label>
                    <input type="text" id="testSubscriptionId" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–¥–ø–∏—Å–∫–∏" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group">
                    <label>–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:</label>
                    <select id="testPaymentProvider" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="yukassa">–ÆKassa</option>
                        <option value="prodamus">Prodamus</option>
                        <option value="kaspi">Kaspi</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="triggerTestWebhook()">‚úÖ –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É</button>
            </div>

            <h3 style="margin-top: 30px;">–†–µ–∑—É–ª—å—Ç–∞—Ç</h3>
            <div id="testResult" style="background: white; padding: 20px; border-radius: 8px; min-height: 100px;">
                <p style="color: #999;">–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</p>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="commentModal" class="modal">
        <div class="modal-content">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
            <div id="modalError"></div>
            <div class="form-group">
                <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                <textarea id="commentText"></textarea>
            </div>
            <div class="form-group">
                <label>–í–∞—à–µ –∏–º—è:</label>
                <input type="text" id="commentBy" value="Admin">
            </div>
            <button class="btn btn-success" onclick="submitComment()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <button class="btn" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ -->
    <div id="addSubscriptionModal" class="modal">
        <div class="modal-content">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</h3>
            <div id="subscriptionModalError"></div>
            <div id="subscriptionModalSuccess"></div>
            <div class="form-group">
                <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</label>
                <input type="text" id="subscriptionUserName" disabled>
                <input type="hidden" id="subscriptionUserId">
            </div>
            <div class="form-group">
                <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–µ–π):</label>
                <input type="number" id="subscriptionDuration" value="30" min="1" max="365">
            </div>
            <button class="btn btn-success" onclick="addSubscription()">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="btn" onclick="closeSubscriptionModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º API_URL –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —Ö–æ—Å—Ç–∞
        const API_URL = window.location.origin + '/api';
        let authToken = '';
        let currentDrawingId = '';

        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span style="font-size: 20px;">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è'}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300); // –í—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏
            }, 3000);
        }

        function authenticate() {
            authToken = document.getElementById('apiKey').value;
            if (authToken) {
                localStorage.setItem('adminToken', authToken);
                document.getElementById('connectionStatus').className = 'status connected';
                document.getElementById('connectionStatus').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                loadStats();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∏–∑ localStorage
        window.onload = function() {
            const savedToken = localStorage.getItem('adminToken');
            if (savedToken) {
                document.getElementById('apiKey').value = savedToken;
                authenticate();
            }
        };

        async function apiRequest(endpoint, options = {}) {
            const headers = {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json',
                ...options.headers
            };

            const config = {
                ...options,
                headers
            };

            const response = await fetch(`${API_URL}${endpoint}`, config);

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API request failed: ${response.status} - ${errorText}`);
            }

            return response.json();
        }

        async function loadStats() {
            try {
                const data = await apiRequest('/stats');
                const html = `
                    <div class="stat-card">
                        <h3>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                        <div class="value">${data.users.total}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏</h3>
                        <div class="value">${data.users.active}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–ù–æ–≤—ã—Ö –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
                        <div class="value">${data.users.newUsers}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–í—Å–µ–≥–æ –ø–æ–¥–ø–∏—Å–æ–∫</h3>
                        <div class="value">${data.payments.totalSubscriptions}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–û–±—â–∏–π –¥–æ—Ö–æ–¥</h3>
                        <div class="value">${data.payments.totalRevenue.toLocaleString()} ‚Ç∏</div>
                    </div>
                    <div class="stat-card">
                        <h3>–î–æ—Ö–æ–¥ –∑–∞ –º–µ—Å—è—Ü</h3>
                        <div class="value">${data.payments.monthlyRevenue.toLocaleString()} ‚Ç∏</div>
                    </div>
                    <div class="stat-card">
                        <h3>–í—Å–µ–≥–æ —Ä–∏—Å—É–Ω–∫–æ–≤</h3>
                        <div class="value">${data.drawings.total}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–û–∂–∏–¥–∞—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</h3>
                        <div class="value">${data.drawings.pending}</div>
                    </div>
                `;
                document.getElementById('statsData').innerHTML = html;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadUsers() {
            try {
                const users = await apiRequest('/users');
                let html = '<table><tr><th>Telegram ID</th><th>–ò–º—è</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>';
                users.forEach(user => {
                    const hasActiveSubscription = user.subscriptions && user.subscriptions.length > 0;
                    html += `<tr>
                        <td>${user.telegramId}</td>
                        <td>${user.firstName || ''} ${user.lastName || ''}</td>
                        <td>${user.status}</td>
                        <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-success" onclick="openAddSubscriptionModal('${user.id}', '${user.firstName || ''} ${user.lastName || ''}')">
                                ${hasActiveSubscription ? '–ü—Ä–æ–¥–ª–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'} –ø–æ–¥–ø–∏—Å–∫—É
                            </button>
                        </td>
                    </tr>`;
                });
                html += '</table>';
                document.getElementById('usersData').innerHTML = html;
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadLessons() {
            try {
                const lessons = await apiRequest('/lessons');

                if (!lessons || lessons.length === 0) {
                    document.getElementById('lessonsData').innerHTML = '<p style="color: #999;">–ù–µ—Ç —É—Ä–æ–∫–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —É—Ä–æ–∫.</p>';
                    return;
                }

                let html = '<table>';
                html += '<tr><th>‚Ññ</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¢–∏–ø</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–ê–∫—Ç–∏–≤–µ–Ω</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>';

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ order, –ø–æ—Ç–æ–º –ø–æ lessonNumber
                lessons.sort((a, b) => a.order - b.order || a.lessonNumber - b.lessonNumber);

                lessons.forEach(lesson => {
                    const typeBadge = getTypeBadge(lesson.type);
                    const desc = lesson.description || '-';
                    const shortDesc = desc.length > 50 ? desc.substring(0, 50) + '...' : desc;
                    const safeLessonData = encodeURIComponent(JSON.stringify(lesson));
                    const safeTitle = (lesson.title || '').replace(/'/g, '&apos;');

                    html += `<tr>
                        <td><strong>${lesson.lessonNumber}</strong></td>
                        <td>${lesson.title}</td>
                        <td>${typeBadge}</td>
                        <td style="max-width: 200px;">${shortDesc}</td>
                        <td>${lesson.isActive ? '‚úÖ' : '‚ùå'}</td>
                        <td style="white-space: nowrap;">
                            <button class="btn btn-primary" onclick="editLessonSafe('${safeLessonData}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="btn btn-danger" onclick="deleteLessonSafe('${lesson.id}', '${safeTitle}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        </td>
                    </tr>`;
                });
                html += '</table>';
                document.getElementById('lessonsData').innerHTML = html;
            } catch (error) {
                console.error('Error loading lessons:', error);
                document.getElementById('lessonsData').innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–∫–æ–≤</p>';
            }
        }

        function getTypeBadge(type) {
            const badges = {
                'FREE': '<span style="background: #4CAF50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">FREE</span>',
                'PREMIUM': '<span style="background: #FF9800; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">PREMIUM</span>',
            };
            return badges[type] || type;
        }

        function openAddLessonModal() {
            document.getElementById('lessonModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫';
            document.getElementById('lessonId').value = '';
            document.getElementById('lessonNumber').value = '';
            document.getElementById('lessonType').value = 'PREMIUM';
            document.getElementById('lessonTitle').value = '';
            document.getElementById('lessonDescription').value = '';
            document.getElementById('lessonPreviewUrl').value = '';
            document.getElementById('lessonFullUrl').value = '';
            document.getElementById('lessonPractice').value = '';
            document.getElementById('lessonOrder').value = '0';
            document.getElementById('lessonActive').checked = true;

            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ
            lessonVideos = [];
            videoIdCounter = 0;
            renderLessonVideos();

            document.getElementById('lessonModal').style.display = 'block';
        }

        function editLessonSafe(encodedLessonData) {
            try {
                const lesson = JSON.parse(decodeURIComponent(encodedLessonData));
                editLesson(lesson);
            } catch (error) {
                console.error('Error parsing lesson data:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —É—Ä–æ–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            }
        }

        function editLesson(lesson) {
            document.getElementById('lessonModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Ä–æ–∫';
            document.getElementById('lessonId').value = lesson.id;
            document.getElementById('lessonNumber').value = lesson.lessonNumber;
            document.getElementById('lessonType').value = lesson.type;
            document.getElementById('lessonTitle').value = lesson.title;
            document.getElementById('lessonDescription').value = lesson.description || '';
            document.getElementById('lessonPreviewUrl').value = lesson.previewVideoUrl || '';
            document.getElementById('lessonFullUrl').value = lesson.fullVideoUrl || '';
            document.getElementById('lessonPractice').value = lesson.practiceText || '';
            document.getElementById('lessonOrder').value = lesson.order;
            document.getElementById('lessonActive').checked = lesson.isActive;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤–∏–¥–µ–æ
            lessonVideos = [];
            videoIdCounter = 0;
            if (lesson.videos && lesson.videos.length > 0) {
                lesson.videos.forEach((video, index) => {
                    const videoId = `video_${videoIdCounter++}`;
                    lessonVideos.push({
                        id: videoId,
                        title: video.title,
                        videoUrl: video.videoUrl,
                        order: video.order || (index + 1)
                    });
                });
            }
            renderLessonVideos();

            document.getElementById('lessonModal').style.display = 'block';
        }

        function deleteLessonSafe(lessonId, safeTitle) {
            const title = safeTitle.replace(/&apos;/g, "'");
            deleteLesson(lessonId, title);
        }

        // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∏–¥–µ–æ —É—Ä–æ–∫–∞
        let lessonVideos = [];
        let videoIdCounter = 0;

        function addLessonVideo() {
            const videoId = `video_${videoIdCounter++}`;
            lessonVideos.push({
                id: videoId,
                title: '',
                videoUrl: '',
                order: lessonVideos.length + 1
            });
            renderLessonVideos();
        }

        function removeLessonVideo(videoId) {
            lessonVideos = lessonVideos.filter(v => v.id !== videoId);
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫
            lessonVideos.forEach((v, index) => v.order = index + 1);
            renderLessonVideos();
        }

        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è onclick
        window.removeLessonVideo = removeLessonVideo;

        function renderLessonVideos() {
            const container = document.getElementById('lessonVideos');
            if (lessonVideos.length === 0) {
                container.innerHTML = '<p style="color: #666;">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ –Ω–µ—Ç</p>';
                return;
            }

            container.innerHTML = lessonVideos.map((video, index) => `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>–í–∏–¥–µ–æ ${index + 1}</strong>
                        <button type="button" class="btn btn-danger" onclick="window.removeLessonVideo('${video.id}')">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ:</label>
                        <input type="text" class="video-title" data-id="${video.id}" value="${video.title}"
                            placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label>URL –≤–∏–¥–µ–æ:</label>
                        <input type="url" class="video-url" data-id="${video.id}" value="${video.videoUrl}"
                            placeholder="https://youtube.com/..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
            `).join('');

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            container.querySelectorAll('.video-title').forEach(input => {
                input.addEventListener('change', (e) => {
                    const video = lessonVideos.find(v => v.id === e.target.dataset.id);
                    if (video) video.title = e.target.value.trim();
                });
            });

            container.querySelectorAll('.video-url').forEach(input => {
                input.addEventListener('change', (e) => {
                    const video = lessonVideos.find(v => v.id === e.target.dataset.id);
                    if (video) video.videoUrl = e.target.value.trim();
                });
            });
        }

        function closeLessonModal() {
            document.getElementById('lessonModal').style.display = 'none';
            lessonVideos = [];
            videoIdCounter = 0;
        }

        async function saveLesson() {
            try {
                const lessonId = document.getElementById('lessonId').value;
                const lessonNumber = parseInt(document.getElementById('lessonNumber').value);
                const type = document.getElementById('lessonType').value;
                const title = document.getElementById('lessonTitle').value.trim();
                const description = document.getElementById('lessonDescription').value.trim();
                const previewVideoUrl = document.getElementById('lessonPreviewUrl').value.trim();
                const fullVideoUrl = document.getElementById('lessonFullUrl').value.trim();
                const practiceText = document.getElementById('lessonPractice').value.trim();
                const orderValue = document.getElementById('lessonOrder').value;
                const order = orderValue ? parseInt(orderValue) : 0;
                const isActive = document.getElementById('lessonActive').checked;

                if (!lessonNumber || !type) {
                    showToast('–ù–æ–º–µ—Ä —É—Ä–æ–∫–∞ –∏ —Ç–∏–ø –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã', 'error');
                    return;
                }

                if (isNaN(lessonNumber)) {
                    showToast('–ù–æ–º–µ—Ä —É—Ä–æ–∫–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º', 'error');
                    return;
                }

                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤ –≤–∏–¥–µ–æ
                const videos = lessonVideos
                    .filter(v => v.title && v.videoUrl) // –¢–æ–ª—å–∫–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –≤–∏–¥–µ–æ
                    .map(v => ({
                        title: v.title,
                        videoUrl: v.videoUrl,
                        order: v.order
                    }));

                const lessonData = {
                    type,
                    title: title || null,
                    description: description || null,
                    previewVideoUrl: previewVideoUrl || null,
                    fullVideoUrl: fullVideoUrl || null,
                    practiceText: practiceText || null,
                    order,
                    isActive,
                    videos: videos  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º)
                };

                if (lessonId) {
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —É—Ä–æ–∫–∞
                    console.log('Updating lesson with lessonNumber:', lessonNumber);
                    await apiRequest(`/lessons/${lessonNumber}`, {
                        method: 'PUT',
                        body: JSON.stringify(lessonData)
                    });
                    showToast('–£—Ä–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                } else {
                    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —É—Ä–æ–∫–∞
                    lessonData.lessonNumber = lessonNumber;
                    console.log('Creating new lesson:', JSON.stringify(lessonData, null, 2));
                    await apiRequest('/lessons', {
                        method: 'POST',
                        body: JSON.stringify(lessonData)
                    });
                    showToast('–£—Ä–æ–∫ —Å–æ–∑–¥–∞–Ω!');
                }

                closeLessonModal();
                loadLessons();
            } catch (error) {
                console.error('Error saving lesson:', error);
                showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        async function deleteLesson(lessonId, lessonTitle) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å —É—Ä–æ–∫ "${lessonTitle}"?\n\n–≠—Ç–æ —Ç–∞–∫–∂–µ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ –∏ —Ä–∏—Å—É–Ω–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤!`)) {
                return;
            }

            try {
                await apiRequest(`/lessons/${lessonId}`, {
                    method: 'DELETE'
                });

                alert('‚úÖ –£—Ä–æ–∫ —É–¥–∞–ª–µ–Ω');
                loadLessons();
            } catch (error) {
                console.error('Error deleting lesson:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É—Ä–æ–∫–∞: ' + error.message);
            }
        }

        async function loadDrawings() {
            try {
                const drawings = await apiRequest('/drawings/uncommented');
                let html = '<table><tr><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–£—Ä–æ–∫</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>';
                drawings.forEach(drawing => {
                    html += `<tr>
                        <td>${drawing.user.firstName || ''} (${drawing.user.telegramId})</td>
                        <td>${drawing.lesson.title}</td>
                        <td>${new Date(drawing.createdAt).toLocaleDateString()}</td>
                        <td><button class="btn btn-primary" onclick="openCommentModal('${drawing.id}')">–ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å</button></td>
                    </tr>`;
                });
                html += '</table>';
                document.getElementById('drawingsData').innerHTML = html;
            } catch (error) {
                console.error('Error loading drawings:', error);
            }
        }

        function openCommentModal(drawingId) {
            currentDrawingId = drawingId;
            document.getElementById('commentModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('commentModal').classList.remove('show');
            document.getElementById('commentText').value = '';
        }

        async function submitComment() {
            const comment = document.getElementById('commentText').value;
            const commentedBy = document.getElementById('commentBy').value;

            if (!comment) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π');
                return;
            }

            try {
                await fetch(`${API_URL}/drawings/${currentDrawingId}/comment`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ comment, commentedBy })
                });
                closeModal();
                loadDrawings();
            } catch (error) {
                console.error('Error submitting comment:', error);
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`${tab}-content`).classList.add('active');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            if (tab === 'test') {
                loadTestPendingPayments();
            }

            switch(tab) {
                case 'stats': loadStats(); break;
                case 'welcome': loadWelcomeSettings(); break;
                case 'payment-settings':
                    loadPaymentSettings();
                    loadPaymentMethods();
                    break;
                case 'users': loadUsers(); break;
                case 'lessons': loadLessons(); break;
                case 'drawings': loadDrawings(); break;
                case 'payments':
                    loadPaymentRequests();
                    loadPendingPayments();
                    loadActivePayments();
                    break;
            }
        }

        function openAddSubscriptionModal(userId, userName) {
            document.getElementById('subscriptionUserId').value = userId;
            document.getElementById('subscriptionUserName').value = userName;
            document.getElementById('subscriptionDuration').value = 30;
            document.getElementById('subscriptionModalError').innerHTML = '';
            document.getElementById('subscriptionModalSuccess').innerHTML = '';
            document.getElementById('addSubscriptionModal').classList.add('show');
        }

        function closeSubscriptionModal() {
            document.getElementById('addSubscriptionModal').classList.remove('show');
        }

        async function addSubscription() {
            const userId = document.getElementById('subscriptionUserId').value;
            const durationDays = parseInt(document.getElementById('subscriptionDuration').value);

            if (!durationDays || durationDays <= 0) {
                document.getElementById('subscriptionModalError').innerHTML = '<div class="error">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0</div>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/users/${userId}/subscription`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ durationDays })
                });

                if (!response.ok) {
                    throw new Error('Failed to add subscription');
                }

                document.getElementById('subscriptionModalSuccess').innerHTML = '<div class="success">–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!</div>';
                setTimeout(() => {
                    closeSubscriptionModal();
                    loadUsers();
                }, 1500);
            } catch (error) {
                console.error('Error adding subscription:', error);
                document.getElementById('subscriptionModalError').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏</div>';
            }
        }

        async function loadPaymentRequests() {
            try {
                const requests = await apiRequest('/payment-requests');
                if (requests.length === 0) {
                    document.getElementById('paymentRequestsData').innerHTML = '<p style="color: #666; padding: 10px;">–ù–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ –æ–ø–ª–∞—Ç—É</p>';
                    return;
                }

                let html = '<table><tr><th>ID</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</th><th>–°—É–º–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th><th>–°—Å—ã–ª–∫–∞</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>';
                requests.forEach(request => {
                    const userName = request.user ? `${request.user.firstName || ''} ${request.user.lastName || ''}`.trim() || '–ë–µ–∑ –∏–º–µ–Ω–∏' : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    const statusText = {
                        'pending': '‚è≥ –û–∂–∏–¥–∞–µ—Ç',
                        'confirmed': '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞',
                        'rejected': '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∞',
                        'cancelled': 'üö´ –û—Ç–º–µ–Ω–µ–Ω–∞'
                    }[request.status] || request.status;

                    const statusColor = {
                        'pending': '#ffc107',
                        'confirmed': '#28a745',
                        'rejected': '#dc3545',
                        'cancelled': '#6c757d'
                    }[request.status] || '#666';

                    const notifyButton = request.status === 'pending'
                        ? `<button class="btn btn-primary" onclick="notifyAdminAboutPayment('${request.id}')" style="font-size: 12px; padding: 5px 10px;">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω—É</button>`
                        : '<span style="color: #999;">‚Äî</span>';

                    const deleteButton = `<button class="btn btn-danger" onclick="deletePaymentRequest('${request.id}')" style="font-size: 12px; padding: 5px 10px; margin-left: 5px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>`;

                    html += `<tr>
                        <td>${request.id.substring(0, 8)}...</td>
                        <td>${userName}<br><small style="color: #666;">@${request.user?.username || 'N/A'} (${request.user?.telegramId || 'N/A'})</small></td>
                        <td>${request.paymentMethodName}</td>
                        <td><strong>${request.price} ${request.currency}</strong></td>
                        <td style="color: ${statusColor}; font-weight: bold;">${statusText}</td>
                        <td>${new Date(request.createdAt).toLocaleString('ru-RU', { timeZone: 'Asia/Almaty' })}</td>
                        <td><a href="${request.paymentUrl}" target="_blank" style="color: #007bff; text-decoration: none;">üîó –û—Ç–∫—Ä—ã—Ç—å</a></td>
                        <td>${notifyButton}${deleteButton}</td>
                    </tr>`;
                });
                html += '</table>';
                document.getElementById('paymentRequestsData').innerHTML = html;
            } catch (error) {
                console.error('Error loading payment requests:', error);
                document.getElementById('paymentRequestsData').innerHTML = '<p style="color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫ –Ω–∞ –æ–ø–ª–∞—Ç—É</p>';
            }
        }

        async function notifyAdminAboutPayment(requestId) {
            if (!confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –≤ Telegram?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/payment-requests/${requestId}/notify-admin`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to notify admin');
                }

                const result = await response.json();
                alert('‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É!');
                loadPaymentRequests(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            } catch (error) {
                console.error('Error notifying admin:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ' + error.message);
            }
        }

        async function deletePaymentRequest(requestId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/payment-requests/${requestId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to delete payment request');
                }

                alert('‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!');
                loadPaymentRequests(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            } catch (error) {
                console.error('Error deleting payment request:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏: ' + error.message);
            }
        }

        async function loadPendingPayments() {
            try {
                const payments = await apiRequest('/payments/pending');
                if (payments.length === 0) {
                    document.getElementById('pendingPaymentsData').innerHTML = '<p style="color: #666; padding: 10px;">–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π</p>';
                    return;
                }

                let html = '<table><tr><th>ID</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–°—É–º–º–∞</th><th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>';
                payments.forEach(payment => {
                    const userName = payment.user ? `${payment.user.firstName || ''} ${payment.user.lastName || ''}` : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    html += `<tr>
                        <td>${payment.id.substring(0, 8)}...</td>
                        <td>${userName} (${payment.user?.telegramId || 'N/A'})</td>
                        <td>${payment.price} ${payment.currency}</td>
                        <td>${new Date(payment.createdAt).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-success" onclick="confirmPayment('${payment.id}')">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                        </td>
                    </tr>`;
                });
                html += '</table>';
                document.getElementById('pendingPaymentsData').innerHTML = html;
            } catch (error) {
                console.error('Error loading pending payments:', error);
                document.getElementById('pendingPaymentsData').innerHTML = '<p style="color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–∂–∏–¥–∞—é—â–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π</p>';
            }
        }

        async function loadActivePayments() {
            try {
                const payments = await apiRequest('/payments/active');
                if (payments.length === 0) {
                    document.getElementById('paymentsData').innerHTML = '<p style="color: #666; padding: 10px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</p>';
                    return;
                }

                let html = '<table><tr><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</th><th>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th><th>–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>';
                payments.forEach(payment => {
                    const userName = payment.user ? `${payment.user.firstName || ''} ${payment.user.lastName || ''}` : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    const daysLeft = Math.ceil((new Date(payment.endDate) - new Date()) / (1000 * 60 * 60 * 24));
                    html += `<tr>
                        <td>${userName} (${payment.user?.telegramId || 'N/A'})</td>
                        <td>${new Date(payment.startDate).toLocaleDateString()}</td>
                        <td>${new Date(payment.endDate).toLocaleDateString()}</td>
                        <td>${daysLeft > 0 ? daysLeft : 0} –¥–Ω–µ–π</td>
                        <td><button class="btn btn-danger" onclick="deleteSubscription('${payment.id}')" style="font-size: 12px; padding: 5px 10px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button></td>
                    </tr>`;
                });
                html += '</table>';
                document.getElementById('paymentsData').innerHTML = html;
            } catch (error) {
                console.error('Error loading active payments:', error);
                document.getElementById('paymentsData').innerHTML = '<p style="color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</p>';
            }
        }

        async function deleteSubscription(subscriptionId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–æ–¥–ø–∏—Å–∫—É?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/subscriptions/${subscriptionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to delete subscription');
                }

                alert('‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!');
                loadActivePayments(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            } catch (error) {
                console.error('Error deleting subscription:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏: ' + error.message);
            }
        }

        async function confirmPayment(subscriptionId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —ç—Ç–æ—Ç –ø–ª–∞—Ç–µ–∂?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/payments/${subscriptionId}/confirm`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        paymentId: `ADMIN-${Date.now()}`
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to confirm payment');
                }

                const result = await response.json();
                alert('‚úÖ –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.');

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
                loadPendingPayments();
                loadActivePayments();
                loadStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            } catch (error) {
                console.error('Error confirming payment:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞');
            }
        }

        // ========================================
        // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø –ü–õ–ê–¢–ï–ñ–ï–ô
        // ========================================

        async function loadTestPendingPayments() {
            try {
                const payments = await apiRequest('/payments/pending');
                const container = document.getElementById('testPendingPayments');

                if (!payments || payments.length === 0) {
                    container.innerHTML = '<p style="color: #999;">–ù–µ—Ç pending –ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞.</p>';
                    return;
                }

                let html = '<table><tr><th>ID</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</th><th>–°—É–º–º–∞</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>';
                payments.forEach(payment => {
                    const userName = payment.user?.firstName || payment.user?.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    const providerBadge = getProviderBadge(payment.paymentProvider);

                    html += `<tr>
                        <td title="${payment.id}">${payment.id.substring(0, 8)}...</td>
                        <td>${userName} (${payment.user?.telegramId})</td>
                        <td>${providerBadge}</td>
                        <td>${payment.price} ${payment.currency}</td>
                        <td>${new Date(payment.createdAt).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-primary" onclick="testPayment('${payment.id}', '${payment.paymentProvider}')">
                                üß™ –¢–µ—Å—Ç ${payment.paymentProvider}
                            </button>
                        </td>
                    </tr>`;
                });
                html += '</table>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading test pending payments:', error);
                document.getElementById('testPendingPayments').innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
            }
        }

        function getProviderBadge(provider) {
            const badges = {
                yukassa: '<span style="background: #4CAF50; color: white; padding: 2px 8px; border-radius: 4px;">–ÆKassa</span>',
                prodamus: '<span style="background: #2196F3; color: white; padding: 2px 8px; border-radius: 4px;">Prodamus</span>',
                kaspi: '<span style="background: #FF9800; color: white; padding: 2px 8px; border-radius: 4px;">Kaspi</span>'
            };
            return badges[provider] || provider;
        }

        async function testPayment(subscriptionId, provider) {
            if (!confirm(`–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ ${provider}?`)) {
                return;
            }

            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = '<p style="color: #2196F3;">‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ webhook...</p>';

            try {
                const response = await fetch(`${API_URL}/test/${provider}/success`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ subscriptionId })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                resultDiv.innerHTML = `
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; padding: 15px; color: #155724;">
                        <h4 style="margin-top: 0;">‚úÖ –£—Å–ø–µ—à–Ω–æ!</h4>
                        <p><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> ${result.message}</p>
                        <p><strong>Subscription ID:</strong> ${result.subscription?.id}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${result.subscription?.status}</p>
                        <p><strong>Payment ID:</strong> ${result.subscription?.paymentId}</p>
                        <p><strong>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</strong> ${new Date(result.subscription?.startDate).toLocaleString()}</p>
                        <p><strong>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</strong> ${new Date(result.subscription?.endDate).toLocaleString()}</p>
                        <p style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #c3e6cb;">
                            üí¨ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
                        </p>
                    </div>
                `;

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–∫–∏
                loadTestPendingPayments();
                loadPendingPayments();
                loadActivePayments();
                loadStats();

                alert('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π webhook –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram.');
            } catch (error) {
                console.error('Error testing payment:', error);
                resultDiv.innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 15px; color: #721c24;">
                        <h4 style="margin-top: 0;">‚ùå –û—à–∏–±–∫–∞</h4>
                        <p>${error.message}</p>
                        <p style="font-size: 12px; margin-top: 10px;">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π</p>
                    </div>
                `;
            }
        }

        async function triggerTestWebhook() {
            const subscriptionId = document.getElementById('testSubscriptionId').value.trim();
            const provider = document.getElementById('testPaymentProvider').value;

            if (!subscriptionId) {
                alert('–í–≤–µ–¥–∏—Ç–µ Subscription ID');
                return;
            }

            await testPayment(subscriptionId, provider);
        }

        // ============================================
        // Welcome Settings Functions
        // ============================================

        let currentWelcomeSettings = null;

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–º –ø–æ–ª–∏—Ç–∏–∫–∏
        function insertPolicyFormatting(type) {
            const textarea = document.getElementById('policyTextInput');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const beforeText = textarea.value.substring(0, start);
            const afterText = textarea.value.substring(end);

            let newText = '';
            let cursorOffset = 0;

            switch(type) {
                case 'bold':
                    if (selectedText) {
                        newText = `${beforeText}**${selectedText}**${afterText}`;
                        cursorOffset = start + selectedText.length + 4;
                    } else {
                        newText = `${beforeText}**—Ç–µ–∫—Å—Ç**${afterText}`;
                        cursorOffset = start + 2;
                    }
                    break;
                case 'italic':
                    if (selectedText) {
                        newText = `${beforeText}*${selectedText}*${afterText}`;
                        cursorOffset = start + selectedText.length + 2;
                    } else {
                        newText = `${beforeText}*—Ç–µ–∫—Å—Ç*${afterText}`;
                        cursorOffset = start + 1;
                    }
                    break;
                case 'code':
                    if (selectedText) {
                        newText = `${beforeText}\`${selectedText}\`${afterText}`;
                        cursorOffset = start + selectedText.length + 2;
                    } else {
                        newText = `${beforeText}\`–∫–æ–¥\`${afterText}`;
                        cursorOffset = start + 1;
                    }
                    break;
            }

            textarea.value = newText;
            textarea.focus();
            textarea.setSelectionRange(cursorOffset, cursorOffset);
            updatePolicyPreview();
        }

        function insertPolicyLink() {
            const textarea = document.getElementById('policyTextInput');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const beforeText = textarea.value.substring(0, start);
            const afterText = textarea.value.substring(end);

            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º URL —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const url = prompt('–í–≤–µ–¥–∏—Ç–µ URL —Å—Å—ã–ª–∫–∏:', 'https://example.com');
            if (!url) return;

            let linkText = selectedText || '—Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏';
            const newText = `${beforeText}[${linkText}](${url})${afterText}`;

            textarea.value = newText;
            textarea.focus();

            // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const linkStart = start + 1;
            const linkEnd = linkStart + linkText.length;
            textarea.setSelectionRange(linkStart, linkEnd);
            updatePolicyPreview();
        }

        function insertPolicyNewline() {
            const textarea = document.getElementById('policyTextInput');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const beforeText = textarea.value.substring(0, start);
            const afterText = textarea.value.substring(end);

            const newText = `${beforeText}\n${afterText}`;
            textarea.value = newText;
            textarea.focus();
            textarea.setSelectionRange(start + 1, start + 1);
            updatePolicyPreview();
        }

        function clearPolicyText() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —Ç–µ–∫—Å—Ç?')) {
                document.getElementById('policyTextInput').value = '';
                updatePolicyPreview();
            }
        }

        // Update preview
        function updatePolicyPreview() {
            const text = document.getElementById('policyTextInput').value.trim();
            const previewDiv = document.getElementById('policyPreview');

            if (!text) {
                previewDiv.innerHTML = '<p style="color: #999; font-style: italic;">–ü—Ä–µ–≤—å—é –ø—É—Å—Ç–æ. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤—ã—à–µ.</p>';
                return;
            }

            let html = text;

            // Convert Markdown formatting to HTML
            // Bold: **text** -> <strong>text</strong>
            html = html.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');

            // Italic: *text* -> <em>text</em> (but not ** from bold)
            html = html.replace(/(?<!\*)\*(?!\*)([^\*]+)\*(?!\*)/g, '<em>$1</em>');

            // Code: `text` -> <code>text</code>
            html = html.replace(/`([^`]+)`/g, '<code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-family: monospace;">$1</code>');

            // Links: [text](url) -> <a href="url">text</a>
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #007bff; text-decoration: underline;">$1</a>');

            // Convert newlines to <br>
            html = html.replace(/\n/g, '<br>');

            previewDiv.innerHTML = html;
        }

        async function loadWelcomeSettings() {
            try {
                const settings = await apiRequest('/settings/welcome');
                currentWelcomeSettings = settings;

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('policyTextInput').value = settings.policyText || '';
                document.getElementById('policyButtonInput').value = settings.policyButton || '–Ø —Å–æ–≥–ª–∞—Å–µ–Ω';
                document.getElementById('welcomeTextInput').value = settings.welcomeText || '';
                document.getElementById('welcomeButtonNewbieInput').value = settings.welcomeButtonNewbie || '–ù–æ–≤–∏—á–æ–∫';
                document.getElementById('welcomeButtonExperiencedInput').value = settings.welcomeButtonExperienced || '–£–∂–µ –∑–Ω–∞–∫–æ–º';
                document.getElementById('newbieCtaTextInput').value = settings.newbieCtaText || 'üëÜ –ü–æ—Å–º–æ—Ç—Ä–µ–ª–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —É—Ä–æ–∫–∏?\n\n–ì–æ—Ç–æ–≤—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –ø–æ–ª–Ω–æ–º—É –∫—É—Ä—Å—É?';
                document.getElementById('newbieCtaButtonInput').value = settings.newbieCtaButton || 'üöÄ –•–æ—á—É –≤ –ø—Ä–æ–µ–∫—Ç';

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é –ø–æ–ª–∏—Ç–∏–∫–∏
                updatePolicyPreview();

                // –î–æ–±–∞–≤–ª—è–µ–º event listener –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–≤—å—é –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                const policyTextInput = document.getElementById('policyTextInput');
                if (policyTextInput) {
                    policyTextInput.removeEventListener('input', updatePolicyPreview);
                    policyTextInput.addEventListener('input', updatePolicyPreview);
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
                updateWelcomePreview(settings);
            } catch (error) {
                console.error('Error loading welcome settings:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è', 'error');
            }
        }

        function updateWelcomePreview(settings) {
            // –§–æ—Ç–æ
            const photoContainer = document.getElementById('welcomePreviewPhoto');
            if (settings.welcomePhoto) {
                photoContainer.innerHTML = `<img src="${settings.welcomePhoto}" alt="Welcome" style="max-width: 100%; max-height: 300px; border-radius: 8px;">`;
            } else {
                photoContainer.innerHTML = '<p style="color: #999;">üì∑ –§–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</p>';
            }

            // –¢–µ–∫—Å—Ç
            const textContainer = document.getElementById('welcomePreviewText');
            if (settings.welcomeText) {
                // –ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ Markdown –≤ HTML –¥–ª—è –ø—Ä–µ–≤—å—é
                let html = settings.welcomeText
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    .replace(/`(.+?)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br>');
                textContainer.innerHTML = html;
            } else {
                textContainer.innerHTML = '<p style="color: #999;">–¢–µ–∫—Å—Ç –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω</p>';
            }

            // –ö–Ω–æ–ø–∫–∏
            const buttonsContainer = document.getElementById('welcomePreviewButtons');
            buttonsContainer.innerHTML = `
                <button style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: default;">
                    ${settings.welcomeButtonNewbie || '–ù–æ–≤–∏—á–æ–∫'}
                </button>
                <button style="padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: default;">
                    ${settings.welcomeButtonExperienced || '–£–∂–µ –∑–Ω–∞–∫–æ–º'}
                </button>
            `;
        }

        async function saveWelcomeSettings() {
            try {
                const policyText = document.getElementById('policyTextInput').value.trim();
                const policyButton = document.getElementById('policyButtonInput').value.trim();
                const welcomeText = document.getElementById('welcomeTextInput').value.trim();
                const welcomeButtonNewbie = document.getElementById('welcomeButtonNewbieInput').value.trim();
                const welcomeButtonExperienced = document.getElementById('welcomeButtonExperiencedInput').value.trim();
                const newbieCtaText = document.getElementById('newbieCtaTextInput').value.trim();
                const newbieCtaButton = document.getElementById('newbieCtaButtonInput').value.trim();

                if (!welcomeText) {
                    showToast('–¢–µ–∫—Å—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', 'error');
                    return;
                }

                if (!welcomeButtonNewbie || !welcomeButtonExperienced) {
                    showToast('–¢–µ–∫—Å—Ç—ã –∫–Ω–æ–ø–æ–∫ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏', 'error');
                    return;
                }

                if (!newbieCtaText || !newbieCtaButton) {
                    showToast('–¢–µ–∫—Å—Ç –∏ –∫–Ω–æ–ø–∫–∞ –ø—Ä–∏–∑—ã–≤–∞ –∫ –¥–µ–π—Å—Ç–≤–∏—é –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏', 'error');
                    return;
                }

                const settings = await apiRequest('/settings/welcome', {
                    method: 'PUT',
                    body: JSON.stringify({
                        policyText: policyText || null,
                        policyButton,
                        welcomeText,
                        welcomeButtonNewbie,
                        welcomeButtonExperienced,
                        newbieCtaText,
                        newbieCtaButton,
                    })
                });

                currentWelcomeSettings = settings;
                updateWelcomePreview(settings);

                showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            } catch (error) {
                console.error('Error saving welcome settings:', error);
                showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        async function uploadWelcomePhoto() {
            const fileInput = document.getElementById('welcomePhotoInput');
            const file = fileInput.files[0];

            if (!file) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª', 'error');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
            if (!file.type.startsWith('image/')) {
                showToast('–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (5 –ú–ë)
            if (file.size > 5 * 1024 * 1024) {
                showToast('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5 –ú–ë', 'error');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('photo', file);

                const response = await fetch(`${API_URL}/settings/welcome/photo`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                currentWelcomeSettings = result.settings;
                updateWelcomePreview(result.settings);

                // –û—á–∏—Å—Ç–∏–º input
                fileInput.value = '';

                showToast('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
            } catch (error) {
                console.error('Error uploading photo:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ', 'error');
            }
        }

        async function removeWelcomePhoto() {
            if (!currentWelcomeSettings?.welcomePhoto) {
                showToast('–§–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'error');
                return;
            }

            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è?')) {
                return;
            }

            try {
                await apiRequest('/settings/welcome/photo', {
                    method: 'DELETE'
                });

                currentWelcomeSettings.welcomePhoto = null;
                updateWelcomePreview(currentWelcomeSettings);

                showToast('–§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ');
            } catch (error) {
                console.error('Error removing photo:', error);
                showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ', 'error');
            }
        }

        // ===== PAYMENT SETTINGS FUNCTIONS =====

        let currentPaymentSettings = null;
        let currentPaymentMethods = [];

        function insertPaymentFormatting(type) {
            const textarea = document.getElementById('paymentTextInput');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const beforeText = textarea.value.substring(0, start);
            const afterText = textarea.value.substring(end);

            let newText;
            let cursorOffset = 0;

            switch(type) {
                case 'bold':
                    newText = `${beforeText}**${selectedText || '—Ç–µ–∫—Å—Ç'}**${afterText}`;
                    cursorOffset = selectedText ? 2 : 4;
                    break;
                case 'italic':
                    newText = `${beforeText}*${selectedText || '—Ç–µ–∫—Å—Ç'}*${afterText}`;
                    cursorOffset = selectedText ? 1 : 3;
                    break;
                case 'code':
                    newText = `${beforeText}\`${selectedText || '–∫–æ–¥'}\`${afterText}`;
                    cursorOffset = selectedText ? 1 : 3;
                    break;
            }

            textarea.value = newText;
            const newCursorPos = start + (selectedText ? end - start + cursorOffset : cursorOffset);
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            textarea.focus();
            updatePaymentPreview();
        }

        function insertPaymentLink() {
            const textarea = document.getElementById('paymentTextInput');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const beforeText = textarea.value.substring(0, start);
            const afterText = textarea.value.substring(end);

            const url = prompt('–í–≤–µ–¥–∏—Ç–µ URL —Å—Å—ã–ª–∫–∏:', 'https://example.com');
            if (!url) return;

            const linkText = selectedText || '—Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏';
            const newText = `${beforeText}[${linkText}](${url})${afterText}`;

            textarea.value = newText;
            textarea.focus();
            updatePaymentPreview();
        }

        function insertPaymentNewline() {
            const textarea = document.getElementById('paymentTextInput');
            const start = textarea.selectionStart;
            const beforeText = textarea.value.substring(0, start);
            const afterText = textarea.value.substring(start);

            textarea.value = `${beforeText}\n${afterText}`;
            const newPos = start + 1;
            textarea.setSelectionRange(newPos, newPos);
            textarea.focus();
            updatePaymentPreview();
        }

        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—Å—Ç–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
        function insertAtCursor(textareaId, textToInsert) {
            const textarea = document.getElementById(textareaId);
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const beforeText = textarea.value.substring(0, start);
            const afterText = textarea.value.substring(end);

            textarea.value = `${beforeText}${textToInsert}${afterText}`;
            const newPos = start + textToInsert.length;
            textarea.setSelectionRange(newPos, newPos);
            textarea.focus();

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é –µ—Å–ª–∏ —ç—Ç–æ –ø–æ–ª–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã
            if (textareaId === 'paymentTextInput') {
                updatePaymentPreview();
            }
        }

        function clearPaymentText() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ–ø–ª–∞—Ç–µ?')) {
                document.getElementById('paymentTextInput').value = '';
                updatePaymentPreview();
            }
        }

        function updatePaymentPreview() {
            const text = document.getElementById('paymentTextInput').value.trim();
            const previewDiv = document.getElementById('paymentPreview');

            if (!text) {
                previewDiv.innerHTML = '<p style="color: #999; font-style: italic;">–ü—Ä–µ–≤—å—é –ø—É—Å—Ç–æ. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤—ã—à–µ.</p>';
                return;
            }

            let html = text;

            // Convert Markdown formatting to HTML
            // Bold: **text** -> <strong>text</strong>
            html = html.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');

            // Italic: *text* -> <em>text</em> (but not ** from bold)
            html = html.replace(/(?<!\*)\*(?!\*)([^\*]+)\*(?!\*)/g, '<em>$1</em>');

            // Code: `text` -> <code>text</code>
            html = html.replace(/`([^`]+)`/g, '<code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-family: monospace;">$1</code>');

            // Links: [text](url) -> <a href="url">text</a>
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #007bff; text-decoration: underline;">$1</a>');

            // Convert newlines to <br>
            html = html.replace(/\n/g, '<br>');

            previewDiv.innerHTML = html;
        }

        async function loadPaymentSettings() {
            try {
                const settings = await apiRequest('/settings/payment');
                currentPaymentSettings = settings;

                document.getElementById('paymentTextInput').value = settings.paymentText || '';
                document.getElementById('paymentPriceInput').value = settings.paymentPrice || '';
                document.getElementById('paymentCurrencyInput').value = settings.paymentCurrency || 'KZT';
                document.getElementById('paymentDurationInput').value = settings.paymentDuration || 30;
                document.getElementById('adminTelegramIdInput').value = settings.adminTelegramId || '';

                updatePaymentPreview();
            } catch (error) {
                console.error('Error loading payment settings:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ–ø–ª–∞—Ç—ã', 'error');
            }
        }

        async function savePaymentSettings() {
            try {
                const paymentText = document.getElementById('paymentTextInput').value.trim();
                const paymentPrice = parseInt(document.getElementById('paymentPriceInput').value) || null;
                const paymentCurrency = document.getElementById('paymentCurrencyInput').value;
                const paymentDuration = parseInt(document.getElementById('paymentDurationInput').value) || 30;
                const adminTelegramId = document.getElementById('adminTelegramIdInput').value.trim();

                const settings = await apiRequest('/settings/payment', {
                    method: 'PUT',
                    body: JSON.stringify({
                        paymentText: paymentText || null,
                        paymentPrice,
                        paymentCurrency,
                        paymentDuration,
                        adminTelegramId: adminTelegramId || null,
                    })
                });

                currentPaymentSettings = settings;
                showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø–ª–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            } catch (error) {
                console.error('Error saving payment settings:', error);
                showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        async function loadPaymentMethods() {
            try {
                const methods = await apiRequest('/payment-methods');
                currentPaymentMethods = methods;
                renderPaymentMethodsTable();
            } catch (error) {
                console.error('Error loading payment methods:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã', 'error');
            }
        }

        function renderPaymentMethodsTable() {
            const container = document.getElementById('paymentMethodsTable');

            if (!currentPaymentMethods || currentPaymentMethods.length === 0) {
                container.innerHTML = '<p style="color: #666; padding: 20px; text-align: center;">–ù–µ—Ç —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã" —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π.</p>';
                return;
            }

            const colorNames = {
                'primary': '–°–∏–Ω–∏–π',
                'secondary': '–°–µ—Ä—ã–π',
                'positive': '–ó–µ–ª—ë–Ω—ã–π',
                'negative': '–ö—Ä–∞—Å–Ω—ã–π'
            };

            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 12px; text-align: left;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th style="padding: 12px; text-align: left;">–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É</th>
                            <th style="padding: 12px; text-align: left;">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏</th>
                            <th style="padding: 12px; text-align: center;">–¶–≤–µ—Ç</th>
                            <th style="padding: 12px; text-align: center;">–ü–æ—Ä—è–¥–æ–∫</th>
                            <th style="padding: 12px; text-align: center;">–ê–∫—Ç–∏–≤–µ–Ω</th>
                            <th style="padding: 12px; text-align: center;">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            currentPaymentMethods.forEach(method => {
                const shortUrl = method.paymentUrl.length > 50 ? method.paymentUrl.substring(0, 47) + '...' : method.paymentUrl;
                const colorName = colorNames[method.buttonColor] || '–°–∏–Ω–∏–π';
                html += `
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 12px;">${method.name}</td>
                        <td style="padding: 12px;">
                            <a href="${method.paymentUrl}" target="_blank" style="color: #007bff; text-decoration: none;">
                                ${shortUrl}
                            </a>
                        </td>
                        <td style="padding: 12px;">${method.buttonText}</td>
                        <td style="padding: 12px; text-align: center;">
                            <span style="padding: 4px 8px; background: ${method.buttonColor === 'positive' ? '#28a745' : method.buttonColor === 'negative' ? '#dc3545' : method.buttonColor === 'secondary' ? '#6c757d' : '#007bff'}; color: white; border-radius: 4px; font-size: 12px;">
                                ${colorName}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center;">${method.order}</td>
                        <td style="padding: 12px; text-align: center;">
                            ${method.isActive ? '‚úÖ' : '‚ùå'}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="editPaymentMethod('${method.id}')"
                                    style="padding: 6px 12px; background: #ffc107; color: #000; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                                ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button onclick="deletePaymentMethod('${method.id}')"
                                    style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function showAddPaymentMethodModal() {
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('paymentMethodId').value = '';
            document.getElementById('paymentMethodName').value = '';
            document.getElementById('paymentMethodUrl').value = '';
            document.getElementById('paymentMethodButtonText').value = '';
            document.getElementById('paymentMethodPrice').value = '';
            document.getElementById('paymentMethodCurrency').value = '';
            document.getElementById('paymentMethodOrder').value = '0';
            document.getElementById('paymentMethodActive').checked = true;

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–∫–∏ –Ω–∞ primary
            document.querySelector('input[name="buttonColor"][value="primary"]').checked = true;

            // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            document.getElementById('paymentMethodModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('paymentMethodModal').classList.add('show');
        }

        function closePaymentMethodModal() {
            document.getElementById('paymentMethodModal').classList.remove('show');
        }

        async function savePaymentMethod() {
            const id = document.getElementById('paymentMethodId').value;
            const name = document.getElementById('paymentMethodName').value.trim();
            const paymentUrl = document.getElementById('paymentMethodUrl').value.trim();
            const buttonText = document.getElementById('paymentMethodButtonText').value.trim();
            const buttonColor = document.querySelector('input[name="buttonColor"]:checked').value;
            const order = parseInt(document.getElementById('paymentMethodOrder').value) || 0;
            const isActive = document.getElementById('paymentMethodActive').checked;

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!name) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã', 'error');
                return;
            }
            if (!paymentUrl) {
                showToast('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã', 'error');
                return;
            }
            if (!buttonText) {
                showToast('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏', 'error');
                return;
            }

            const price = document.getElementById('paymentMethodPrice').value.trim();
            const currency = document.getElementById('paymentMethodCurrency').value;

            const data = {
                name,
                paymentUrl,
                buttonText,
                buttonColor,
                price: price ? parseInt(price) : null,
                currency: currency || null,
                order,
                isActive
            };

            try {
                if (id) {
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
                    await apiRequest(`/payment-methods/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                    showToast('–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –æ–±–Ω–æ–≤–ª—ë–Ω!');
                } else {
                    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ
                    await apiRequest('/payment-methods', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    showToast('–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω!');
                }

                closePaymentMethodModal();
                await loadPaymentMethods();
            } catch (error) {
                console.error('Error saving payment method:', error);
                showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        function editPaymentMethod(id) {
            const method = currentPaymentMethods.find(m => m.id === id);
            if (!method) return;

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏
            document.getElementById('paymentMethodId').value = method.id;
            document.getElementById('paymentMethodName').value = method.name;
            document.getElementById('paymentMethodUrl').value = method.paymentUrl;
            document.getElementById('paymentMethodButtonText').value = method.buttonText;
            document.getElementById('paymentMethodPrice').value = method.price || '';
            document.getElementById('paymentMethodCurrency').value = method.currency || '';
            document.getElementById('paymentMethodOrder').value = method.order;
            document.getElementById('paymentMethodActive').checked = method.isActive;

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç
            const colorRadio = document.querySelector(`input[name="buttonColor"][value="${method.buttonColor || 'primary'}"]`);
            if (colorRadio) {
                colorRadio.checked = true;
            }

            // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            document.getElementById('paymentMethodModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('paymentMethodModal').classList.add('show');
        }

        async function deletePaymentMethod(id) {
            const method = currentPaymentMethods.find(m => m.id === id);
            if (!method) return;

            if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã "${method.name}"?`)) {
                return;
            }

            try {
                await apiRequest(`/payment-methods/${id}`, {
                    method: 'DELETE'
                });

                showToast('–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã —É–¥–∞–ª—ë–Ω!');
                await loadPaymentMethods();
            } catch (error) {
                console.error('Error deleting payment method:', error);
                showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
