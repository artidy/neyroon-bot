# Обзор проекта Neyroon Bot

## Что создано

Полнофункциональный Telegram бот для проведения онлайн-курсов по рисованию с интегрированной системой управления, платежами и обратной связью.

## Основные компоненты

### 1. Telegram Bot (Grammy Framework)

**Файлы:**
- `src/bot/index.ts` - основная логика бота
- `src/bot/handlers/` - обработчики команд
- `src/bot/keyboards.ts` - интерактивные клавиатуры
- `src/bot/messages.ts` - текстовые сообщения

**Возможности:**
- Приветствие и онбординг новых пользователей
- Определение уровня (новичок/опытный)
- Отправка вводного и бесплатного урока
- Настройка времени получения уроков (8:00-20:00)
- Загрузка и сохранение рисунков
- Получение комментариев от преподавателя
- Просмотр прогресса и статуса подписки

### 2. База данных (PostgreSQL + Prisma)

**Схема:** `prisma/schema.prisma`

**Таблицы:**
- `User` - пользователи бота
- `Subscription` - подписки пользователей
- `Lesson` - уроки курса (10 штук)
- `Drawing` - рисунки пользователей
- `Admin` - администраторы

**Связи:**
- User → Subscriptions (1:M)
- User → Drawings (1:M)
- Lesson → Drawings (1:M)

### 3. Сервисы (Business Logic)

**userService.ts:**
- Создание и поиск пользователей
- Управление статусами
- Проверка активной подписки
- Статистика пользователей

**lessonService.ts:**
- Управление уроками
- Проверка доступа к урокам
- Инициализация курса

**drawingService.ts:**
- Сохранение рисунков на диск
- Получение непроверенных работ
- Добавление комментариев

**paymentService.ts:**
- Создание подписок
- Интеграция с Kaspi.kz
- Интеграция с ЮKassa
- Статистика платежей

**schedulerService.ts:**
- Ежедневная рассылка уроков по расписанию
- Проверка истекших подписок
- Напоминания неактивным пользователям

### 4. Админ панель (Express.js + REST API)

**Backend:** `src/admin/server.ts`
**Frontend:** `admin-panel/index.html`

**API Endpoints:**

```
GET  /api/stats                    - Общая статистика
GET  /api/users                    - Список пользователей
GET  /api/users/:telegramId        - Информация о пользователе
GET  /api/lessons                  - Список уроков
GET  /api/lessons/:lessonNumber    - Информация об уроке
PUT  /api/lessons/:lessonNumber    - Обновить урок
GET  /api/drawings                 - Список рисунков
GET  /api/drawings/uncommented     - Непроверенные рисунки
POST /api/drawings/:id/comment     - Добавить комментарий
GET  /api/payments/active          - Активные подписки
```

**Админ интерфейс:**
- Дашборд со статистикой
- Просмотр всех пользователей
- Управление уроками
- Проверка и комментирование рисунков
- Просмотр платежей

### 5. Планировщик задач (node-cron)

**Задачи:**
1. Ежечасная проверка на отправку уроков (00 минут каждого часа)
2. Ежедневная проверка истекших подписок (00:00)
3. Еженедельные напоминания неактивным (понедельник 10:00)

## Структура уроков

```
Урок 0: Вводный (INTRO) - доступен всем
Урок 1: Бесплатный (FREE) - только для новичков
Уроки 2-8: Премиум (PREMIUM) - требуют подписку
Урок 9: Финальный (FINAL) - требует подписку, нет видео
```

Каждый урок содержит:
- Короткое превью видео
- Полное видео урока
- Практическое задание

## Система подписок

**Параметры:**
- Цена: 4000 тенге (настраивается в .env)
- Длительность: 30 дней
- Валюта: KZT

**Платежные системы:**
- Kaspi.kz (для Казахстана)
- ЮKassa (для России)

**Статусы подписки:**
- `pending` - ожидает оплаты
- `completed` - оплачена и активна
- `expired` - истекла

## Пользовательские сценарии

### Сценарий 1: Новичок

1. `/start` → приветствие + вводный урок
2. Выбор "Я новичок"
3. Получение бесплатного урока
4. Выбор времени получения уроков
5. Возможность отправить рисунок
6. Предложение оплатить для продолжения

### Сценарий 2: Опытный пользователь

1. `/start` → приветствие + вводный урок
2. Выбор "Уже рисую"
3. Предложение оплатить подписку
4. Выбор времени получения уроков
5. После оплаты - доступ ко всем урокам

### Сценарий 3: Ежедневные уроки

1. В выбранное время бот отправляет:
   - Превью урока
   - Полный урок
   - Практическое задание
2. Пользователь выполняет задание
3. Отправляет рисунок в чат
4. Получает уведомление о сохранении
5. Ждет комментарий от преподавателя

### Сценарий 4: Комментирование (админ)

1. Админ заходит в панель
2. Видит список непроверенных работ
3. Нажимает "Комментировать"
4. Пишет комментарий
5. Отправляет
6. Пользователь получает комментарий в боте

## Технологии и библиотеки

### Backend
- Node.js 18+
- TypeScript 5.9
- Grammy 1.38 (Telegram Bot Framework)
- Express 5.1 (REST API)
- Prisma 6.19 (ORM)
- PostgreSQL 14+

### Утилиты
- dotenv - переменные окружения
- node-cron - планировщик задач
- bcrypt - хеширование паролей
- multer - загрузка файлов

### Dev tools
- nodemon - hot reload
- ts-node - запуск TypeScript
- @types/* - типизация

## Конфигурация (.env)

```env
# Бот
BOT_TOKEN=             # токен от @BotFather

# БД
DATABASE_URL=          # строка подключения PostgreSQL

# Платежи
YUKASSA_SHOP_ID=       # ID магазина ЮKassa
YUKASSA_SECRET_KEY=    # секретный ключ ЮKassa
KASPI_MERCHANT_ID=     # ID мерчанта Kaspi
KASPI_MERCHANT_SECRET= # секретный ключ Kaspi

# Подписка
SUBSCRIPTION_PRICE=4000           # цена
SUBSCRIPTION_CURRENCY=KZT         # валюта
SUBSCRIPTION_DURATION_DAYS=30     # длительность

# Админ панель
ADMIN_PORT=3000               # порт
ADMIN_SECRET=your_secret      # ключ для API

# Загрузки
UPLOAD_PATH=./uploads         # путь к файлам
MAX_FILE_SIZE=10485760        # макс размер (10MB)

# Расписание
TIMEZONE=Asia/Almaty          # часовой пояс
DEFAULT_LESSON_TIME=10:00     # время по умолчанию
```

## Команды для разработки

```bash
# Установка
npm install

# База данных
npm run prisma:generate    # генерация клиента
npm run prisma:migrate     # миграции
npm run prisma:studio      # GUI для БД
npm run prisma:seed        # заполнение тестовыми данными

# Запуск
npm run dev                # режим разработки
npm run build              # сборка
npm start                  # запуск продакшн

# Дополнительно
npm run prisma:studio      # открыть Prisma Studio
```

## Что нужно доделать перед запуском

### 1. Создать видео уроки
- Записать 10 видео уроков
- Загрузить на YouTube/Google Drive/Vimeo
- Получить ссылки

### 2. Обновить уроки в базе
```bash
# Через API или Prisma Studio добавить ссылки
curl -X PUT http://localhost:3000/api/lessons/0 \
  -H "Authorization: Bearer your_secret" \
  -d '{"previewVideoUrl": "...", "fullVideoUrl": "..."}'
```

### 3. Настроить платежные системы

**Kaspi.kz:**
1. Зарегистрироваться в Kaspi Merchant
2. Получить Merchant ID и Secret
3. Реализовать webhook в `paymentService.ts`

**ЮKassa:**
1. Создать аккаунт на yookassa.ru
2. Получить Shop ID и Secret Key
3. Настроить webhook URL
4. Реализовать обработку в `paymentService.ts`

### 4. Деплой на VPS

1. Арендовать VPS (Ubuntu 22.04+)
2. Установить Node.js и PostgreSQL
3. Клонировать репозиторий
4. Настроить .env
5. Запустить миграции
6. Установить PM2
7. Запустить бота

## Мониторинг и поддержка

### Логи
- Все события логируются в консоль
- В продакшене можно настроить Winston/Pino

### Метрики
- Админ панель: статистика в реальном времени
- Prisma Studio: прямой доступ к БД

### Бэкапы
```bash
# Создать бэкап БД
pg_dump neyroon_bot > backup.sql

# Восстановить
psql neyroon_bot < backup.sql
```

## Безопасность

- ✅ API защищен Bearer токеном
- ✅ Пароли админов хешируются (bcrypt)
- ✅ SQL injection защита (Prisma)
- ⚠️ Для продакшена добавить HTTPS
- ⚠️ Для продакшена добавить rate limiting
- ⚠️ Для продакшена настроить CORS

## Масштабирование

При росте пользователей:
1. Вынести файлы на S3/Cloud Storage
2. Добавить Redis для кеширования
3. Настроить балансировку нагрузки
4. Разделить БД и приложение на разные серверы
5. Добавить мониторинг (Prometheus + Grafana)

## Контакты и поддержка

Для вопросов по проекту обращайтесь к разработчику.

---

**Дата создания:** 15 ноября 2025
**Версия:** 1.0.0
**Статус:** Ready for production (после настройки платежей и добавления видео)
