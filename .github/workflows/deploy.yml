name: Deploy to VPS

on:
  push:
    branches:
      - main  # Ğ¸Ğ»Ğ¸ master, Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ğ²Ğ°ÑˆĞµĞ¹ Ğ²ĞµÑ‚ĞºĞ¸
      - production  # Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½ÑƒÑ production Ğ²ĞµÑ‚ĞºÑƒ

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    environment: DEPLOY_SECRET  # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ environment

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          envs: BOT_TOKEN,POSTGRES_PASSWORD,ADMIN_SECRET,JWT_SECRET,KASPI_MERCHANT_ID,KASPI_MERCHANT_SECRET,PRODAMUS_API_KEY,PRODAMUS_SECRET_KEY,PRODAMUS_PROJECT_ID,SUBSCRIPTION_PRICE,SUBSCRIPTION_CURRENCY
          script: |
            cd /opt/neyroon-bot

            echo "ğŸ“¥ Pulling latest changes from GitHub..."
            git pull origin main

            echo "ğŸ”§ Creating .env file from GitHub Secrets..."
            echo "# Auto-generated .env from GitHub Secrets" > .env
            echo "# Generated at: $(date)" >> .env
            echo "" >> .env
            echo "# Telegram Bot" >> .env
            echo "BOT_TOKEN=$BOT_TOKEN" >> .env
            echo "BOT_USERNAME=neyroon_bot" >> .env
            echo "" >> .env
            echo "# Database" >> .env
            echo "POSTGRES_PASSWORD=$POSTGRES_PASSWORD" >> .env
            echo "DATABASE_URL=postgresql://neyroon_user:$POSTGRES_PASSWORD@postgres:5432/neyroon_bot?schema=public" >> .env
            echo "" >> .env
            echo "# Payment Systems" >> .env
            echo "KASPI_MERCHANT_ID=$KASPI_MERCHANT_ID" >> .env
            echo "KASPI_MERCHANT_SECRET=$KASPI_MERCHANT_SECRET" >> .env
            echo "PRODAMUS_API_KEY=$PRODAMUS_API_KEY" >> .env
            echo "PRODAMUS_SECRET_KEY=$PRODAMUS_SECRET_KEY" >> .env
            echo "PRODAMUS_PROJECT_ID=$PRODAMUS_PROJECT_ID" >> .env
            echo "" >> .env
            echo "# Bot Settings" >> .env
            echo "WEBHOOK_URL=https://example.com" >> .env
            echo "" >> .env
            echo "# Subscription Settings" >> .env
            echo "SUBSCRIPTION_PRICE=$SUBSCRIPTION_PRICE" >> .env
            echo "SUBSCRIPTION_CURRENCY=$SUBSCRIPTION_CURRENCY" >> .env
            echo "SUBSCRIPTION_DURATION_DAYS=30" >> .env
            echo "" >> .env
            echo "# Admin Panel" >> .env
            echo "ADMIN_PORT=3000" >> .env
            echo "ADMIN_SECRET=$ADMIN_SECRET" >> .env
            echo "JWT_SECRET=$JWT_SECRET" >> .env
            echo "" >> .env
            echo "# File Storage" >> .env
            echo "UPLOAD_PATH=./uploads" >> .env
            echo "MAX_FILE_SIZE=10485760" >> .env
            echo "" >> .env
            echo "# Scheduler" >> .env
            echo "TIMEZONE=Asia/Almaty" >> .env
            echo "DEFAULT_LESSON_TIME=10:00" >> .env
            echo "" >> .env
            echo "# Node Environment" >> .env
            echo "NODE_ENV=production" >> .env

            echo "âœ… .env file created with secrets from GitHub"

            echo "ğŸ›‘ Stopping containers..."
            docker-compose -f docker-compose.prod.yml down

            echo "ğŸ—ï¸  Building new images..."
            docker-compose -f docker-compose.prod.yml build --no-cache

            echo "ğŸš€ Starting containers..."
            docker-compose -f docker-compose.prod.yml up -d

            echo "â³ Waiting for services to start..."
            sleep 10

            echo "ğŸ” Checking container status..."
            docker-compose -f docker-compose.prod.yml ps

            echo "ğŸ“‹ Showing recent logs..."
            docker-compose -f docker-compose.prod.yml logs --tail 20 bot

            echo "âœ… Deployment completed!"

            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° health endpoint
            if curl -s http://localhost:3000/health | grep -q "ok"; then
              echo "âœ… Health check passed!"
            else
              echo "âŒ Health check failed!"
              exit 1
            fi
