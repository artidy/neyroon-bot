name: Deploy to VPS

on:
  push:
    branches:
      - main  # –∏–ª–∏ master, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∞—à–µ–π –≤–µ—Ç–∫–∏
      - production  # –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é production –≤–µ—Ç–∫—É

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    environment: DEPLOY_SECRET  # –î–æ–±–∞–≤–ª—è–µ–º environment

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd /opt/neyroon-bot

            echo "üì• Pulling latest changes from GitHub..."
            git pull origin main

            echo "üõë Stopping containers..."
            docker-compose -f docker-compose.prod.yml down

            echo "üèóÔ∏è  Building new images..."
            docker-compose -f docker-compose.prod.yml build --no-cache

            echo "üöÄ Starting containers..."
            docker-compose -f docker-compose.prod.yml up -d

            echo "‚è≥ Waiting for services to start..."
            sleep 10

            echo "üîç Checking container status..."
            docker-compose -f docker-compose.prod.yml ps

            echo "üìã Showing recent logs..."
            docker-compose -f docker-compose.prod.yml logs --tail 20 bot

            echo "‚úÖ Deployment completed!"

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ health endpoint
            if curl -s http://localhost:3000/health | grep -q "ok"; then
              echo "‚úÖ Health check passed!"
            else
              echo "‚ùå Health check failed!"
              exit 1
            fi
