name: Build and Deploy

on:
  push:
    branches:
      - main
      - production

jobs:
  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/neyroon-bot
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/neyroon-bot:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/neyroon-bot:buildcache,mode=max

  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    needs: build
    environment: DEPLOY_SECRET

    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          envs: BOT_TOKEN,POSTGRES_PASSWORD,ADMIN_SECRET,JWT_SECRET,KASPI_MERCHANT_ID,KASPI_MERCHANT_SECRET,YUKASSA_SECRET_KEY,YUKASSA_SHOP_ID,SUBSCRIPTION_PRICE,SUBSCRIPTION_CURRENCY,DOCKER_USERNAME
          script: |
            echo "ðŸ“ Setting up project directory..."
            sudo mkdir -p /opt/neyroon-bot/uploads/{drawings,videos,welcome}
            sudo chown -R $USER:$USER /opt/neyroon-bot
            cd /opt/neyroon-bot

            echo "ðŸ”§ Creating .env file from GitHub Secrets..."
            echo "# Auto-generated .env from GitHub Secrets" > .env
            echo "# Generated at: $(date)" >> .env
            echo "" >> .env
            echo "# Telegram Bot" >> .env
            echo "BOT_TOKEN=$BOT_TOKEN" >> .env
            echo "BOT_USERNAME=neyroon_bot" >> .env
            echo "" >> .env
            echo "# Database" >> .env
            echo "POSTGRES_PASSWORD=$POSTGRES_PASSWORD" >> .env
            echo "DATABASE_URL=postgresql://neyroon_user:$POSTGRES_PASSWORD@postgres:5432/neyroon_bot?schema=public" >> .env
            echo "" >> .env
            echo "# Payment Systems" >> .env
            echo "KASPI_MERCHANT_ID=$KASPI_MERCHANT_ID" >> .env
            echo "KASPI_MERCHANT_SECRET=$KASPI_MERCHANT_SECRET" >> .env
            echo "YUKASSA_SECRET_KEY=$YUKASSA_SECRET_KEY" >> .env
            echo "YUKASSA_SHOP_ID=$YUKASSA_SHOP_ID" >> .env
            echo "" >> .env
            echo "# Bot Settings" >> .env
            echo "WEBHOOK_URL=https://example.com" >> .env
            echo "" >> .env
            echo "# Subscription Settings" >> .env
            echo "SUBSCRIPTION_PRICE=$SUBSCRIPTION_PRICE" >> .env
            echo "SUBSCRIPTION_CURRENCY=$SUBSCRIPTION_CURRENCY" >> .env
            echo "SUBSCRIPTION_DURATION_DAYS=30" >> .env
            echo "" >> .env
            echo "# Admin Panel" >> .env
            echo "ADMIN_PORT=3000" >> .env
            echo "ADMIN_SECRET=$ADMIN_SECRET" >> .env
            echo "JWT_SECRET=$JWT_SECRET" >> .env
            echo "" >> .env
            echo "# File Storage" >> .env
            echo "UPLOAD_PATH=./uploads" >> .env
            echo "MAX_FILE_SIZE=10485760" >> .env
            echo "" >> .env
            echo "# Scheduler" >> .env
            echo "TIMEZONE=Asia/Almaty" >> .env
            echo "DEFAULT_LESSON_TIME=10:00" >> .env
            echo "" >> .env
            echo "# Node Environment" >> .env
            echo "NODE_ENV=production" >> .env
            echo "" >> .env
            echo "# Docker Image" >> .env
            echo "DOCKER_IMAGE=$DOCKER_USERNAME/neyroon-bot:latest" >> .env

            echo "âœ… .env file created with secrets from GitHub"

            echo "ðŸ“„ Creating docker-compose.prod.yml if not exists..."
            if [ ! -f docker-compose.prod.yml ]; then
              cat > docker-compose.prod.yml << 'COMPOSE_EOF'
            services:
              postgres:
                image: postgres:14-alpine
                container_name: neyroon-postgres
                restart: always
                environment:
                  POSTGRES_USER: neyroon_user
                  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
                  POSTGRES_DB: neyroon_bot
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                networks:
                  - neyroon-network
                healthcheck:
                  test: ["CMD-SHELL", "pg_isready -U neyroon_user -d neyroon_bot"]
                  interval: 10s
                  timeout: 5s
                  retries: 5

              bot:
                image: ${DOCKER_IMAGE:-neyroon-bot:latest}
                container_name: neyroon-bot
                restart: always
                depends_on:
                  postgres:
                    condition: service_healthy
                environment:
                  NODE_ENV: production
                  DATABASE_URL: postgresql://neyroon_user:${POSTGRES_PASSWORD:-changeme}@postgres:5432/neyroon_bot?schema=public
                env_file:
                  - .env
                ports:
                  - "3000:3000"
                volumes:
                  - ./uploads:/app/uploads
                networks:
                  - neyroon-network
                healthcheck:
                  test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/health || exit 1"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s

            networks:
              neyroon-network:
                driver: bridge

            volumes:
              postgres_data:
                driver: local
            COMPOSE_EOF
              echo "âœ… docker-compose.prod.yml created"
            else
              echo "âœ… docker-compose.prod.yml already exists"
            fi

            echo "ðŸ“¥ Pulling latest Docker image..."
            docker pull $DOCKER_USERNAME/neyroon-bot:latest

            echo "ðŸ›‘ Stopping containers..."
            docker compose -f docker-compose.prod.yml down

            echo "ðŸš€ Starting containers with new image..."
            docker compose -f docker-compose.prod.yml up -d

            echo "â³ Waiting for services to start..."
            sleep 10

            echo "ðŸ” Checking container status..."
            docker-compose -f docker-compose.prod.yml ps

            echo "ðŸ“‹ Showing recent logs..."
            docker-compose -f docker-compose.prod.yml logs --tail 20 bot

            echo "âœ… Deployment completed!"

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° health endpoint
            if curl -s http://localhost:3000/health | grep -q "ok"; then
              echo "âœ… Health check passed!"
            else
              echo "âŒ Health check failed!"
              exit 1
            fi
