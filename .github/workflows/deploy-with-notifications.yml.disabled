name: Deploy to VPS with Notifications

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ GitHub UI

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Send Telegram notification - Start
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_ADMIN_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            üöÄ –ù–∞—á–∏–Ω–∞—é —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Neyroon Bot

            –ö–æ–º–º–∏—Ç: ${{ github.event.head_commit.message }}
            –ê–≤—Ç–æ—Ä: ${{ github.actor }}
            –í–µ—Ç–∫–∞: ${{ github.ref_name }}

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd /opt/neyroon-bot

            echo "üì• Pulling latest changes from GitHub..."
            git pull origin ${{ github.ref_name }}

            echo "üõë Stopping containers..."
            docker-compose -f docker-compose.prod.yml down

            echo "üèóÔ∏è  Building new images..."
            docker-compose -f docker-compose.prod.yml build --no-cache

            echo "üöÄ Starting containers..."
            docker-compose -f docker-compose.prod.yml up -d

            echo "‚è≥ Waiting for services to start..."
            sleep 10

            echo "üîç Checking container status..."
            docker-compose -f docker-compose.prod.yml ps

            echo "üìã Showing recent logs..."
            docker-compose -f docker-compose.prod.yml logs --tail 20 bot

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ health endpoint
            if curl -s http://localhost:3000/health | grep -q "ok"; then
              echo "‚úÖ Health check passed!"
            else
              echo "‚ùå Health check failed!"
              exit 1
            fi

      - name: Send Telegram notification - Success
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_ADMIN_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!

            –ü—Ä–æ–µ–∫—Ç: Neyroon Bot
            –ö–æ–º–º–∏—Ç: ${{ github.event.head_commit.message }}
            –í—Ä–µ–º—è: ${{ github.event.head_commit.timestamp }}

      - name: Send Telegram notification - Failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_ADMIN_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è!

            –ü—Ä–æ–µ–∫—Ç: Neyroon Bot
            –ö–æ–º–º–∏—Ç: ${{ github.event.head_commit.message }}
            –ê–≤—Ç–æ—Ä: ${{ github.actor }}

            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
